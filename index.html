<!doctype html>
<html lang="en">

  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <title>Smart forms</title>
  </head>

  <body>
    <div class="container">

      <h1>Welcome to Smart forms!</h1>
      <br>
      <form action="" method="get">
        <div class="form-row">
          <div class="form-group">
            <select id="typeInputState" class="form-control" onchange="clear_form();">
              <option selected>Select request type...</option>
              <option>CLIENTISSUE</option>
              <option>COMPUTERUPGRADE</option>
              <option>DATATRANSFER</option>
              <option>EMPLOYEEONBOARDING</option>
              <option>CLINICTRIAL</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group col-md-4">
            <input type="text" class="form-control" id="fieldname" name="fieldname[]" value="" placeholder="Enter field name">
          </div>
          <div class="form-group col-md-4">
            <input type="text" class="form-control" id="value" name="value[]" value="" placeholder="Enter value">
          </div>
          <div class="form-group col-md-2">
            <button class="btn btn-success" type="button" onclick="create_smartform_field('');"> + </button>
          </div>
        </div>

        <div id="smartform_fields">
        </div>

        <div class="form-row">
          <div class="form-group col-md-4">
            <button type="button" class="btn btn-info" onclick="get_recommendations();">Get Recommendations</button>
          </div>
        </div>
        <div id='alertuser' class='hide'></div>
        <button type="button" class="btn btn-info" onclick="clear_form();">Clear</button>
        <button type="submit" class="btn btn-primary" disabled>Save</button>
      </form>
    </div>
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript">
      var maxfieldId = 1;
      $('#alertuser').hide()

      function showAlert(message) {
        $('#alertuser').html("<div class='alert alert-danger'>" + message + "</div>");
        $('#alertuser').show();
      }

      function clear_form() {
        var typeObj = document.getElementById('typeInputState')
        if (typeObj.value != 'Select request type...') {
          $('#alertuser').hide()
        }

        for (i = 1; i <= maxfieldId; i++) {
          remove_smartform_field(i);
        }
        maxfieldId = 1;
      }

      function get_recommendations() {
        var typeObj = document.getElementById('typeInputState')
        if (typeObj.value == 'Select request type...') {
          showAlert("Must select the request type to get recommendations. Please select request type and try again.")
          return
        }
        $('#alertuser').hide()

        type = typeObj.value;
        fields = 'type';
        var obj = $('input[name="fieldname[]"]');
        $.each(obj, function(index, myelement) {
          var field = myelement.value;
          if (field != '' && field != 'type') {
            fields = fields + "," + myelement.value;
          }
        });
        console.log("fields = " + fields);
        //api_endpoint_url = 'https://8eupdg6gm2.execute-api.us-east-1.amazonaws.com/default/getRecommendationsFunc'
        api_endpoint_url = 'https://8a0e9lvnhk.execute-api.us-east-1.amazonaws.com/default/getRecommendationsFunc'
        url = api_endpoint_url + '?type=' + type + '&fields=' + fields;
        console.log(url);

        $.getJSON(url, function(result) {
          console.log("result = " + result)
          fieldstr = result['result'];
          console.log('fieldstr = ' + fieldstr)
          if (fieldstr == '') {
            console.log("showAlert : No recommendations for current set of fields")
            showAlert("No recommendations for current set of fields");
          }
          console.log(fieldstr);
          if (fieldstr != '') {
            var newfields = fieldstr.split(',');
            var len = newfields.length;
            for (var i = 0; i < len; i++) {
              console.log(" New field @ index " + i + " = " + newfields[i]);
              create_smartform_field(newfields[i]);
            }
          }
        })
      }

      function create_smartform_field(newfieldname) {
        maxfieldId++;
        var objTo = document.getElementById('smartform_fields')
        var divtest = document.createElement("div");
        divtest.setAttribute("class", "form-group removeclass" + maxfieldId);
        divtest.setAttribute("id", "removeclass" + maxfieldId);
        var rdiv = 'removeclass' + maxfieldId;
        divtest.innerHTML =
          '<div class="form-row">' +
          '<div class="form-group col-md-4">' +
          '<input type="text" class="form-control" id="fieldname" name="fieldname[]" value="' + newfieldname + '" placeholder="Enter field name">' +
          '</div>' +
          '<div class="form-group col-md-4">' +
          '<input type="text" class="form-control" id="value" name="value[]" value="" placeholder="Enter value">' +
          '</div>' +
          '<div class="form-group col-md-2">' +
          '<button class="btn btn-danger" type="button" onclick="remove_smartform_field(' + maxfieldId + ');"> - </button>' +
          '</div>' +
          '</div>';
        objTo.appendChild(divtest)
      }

      function remove_smartform_field(rid) {
        $('.removeclass' + rid).remove();
      }
    </script>
  </body>

</html>